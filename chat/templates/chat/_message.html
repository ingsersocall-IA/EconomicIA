<div id="message-{{ message.id }}"
     class="group w-full flex mb-4 {% if message.role == 'user' %}justify-end{% else %}justify-start{% endif %}"
     data-id="{{ message.id }}" data-role="{{ message.role }}">
  <div class="flex items-start gap-2 {% if message.role == 'user' %}flex-row-reverse{% endif %}">

    {% if can_save %}
    <div class="flex flex-col gap-1 mt-2 {% if message.role == 'user' %}order-3{% endif %}">
      <!-- selector persistente -->
      <label class="inline-flex items-center cursor-pointer select-none" title="Seleccionar para guardar">
        <input type="checkbox" class="save-select peer sr-only" data-id="{{ message.id }}" data-role="{{ message.role }}">
        <span class="h-5 w-5 rounded-full border-2 border-gray-400 flex items-center justify-center transition
                     peer-checked:border-emerald-500 peer-checked:bg-emerald-500">
          <svg class="h-3 w-3 text-transparent peer-checked:text-white pointer-events-none"
               viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" aria-hidden="true">
            <path d="M20 6L9 17l-5-5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
      </label>
    </div>
    {% endif %}

    <!-- Acciones (hover) -->
    <div class="opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition-opacity flex flex-col gap-1 mt-2 {% if message.role == 'user' %}order-2{% endif %}">
      <!-- Copiar globo -->
      <button type="button"
              class="p-1 text-gray-400 hover:text-emerald-600 btn-copy-bubble"
              data-msg-id="{{ message.id }}"
              title="Copiar mensaje">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M9 2h6a2 2 0 012 2h1a2 2 0 012 2v12a2 2 0 01-2 2H8a2 2 0 01-2-2V6a2 2 0 012-2h1a2 2 0 012-2zm0 2a1 1 0 00-1 1v1h8V5a1 1 0 00-1-1H9z"/>
        </svg>
      </button>

      <!-- Eliminar 1 -->
      <button
              hx-post="{% url 'delete_single_message' message.id %}"
              hx-target="#message-{{ message.id }}"
              hx-swap="outerHTML"
              hx-confirm="¿Seguro que quieres eliminar este mensaje?"
              class="p-1 text-gray-400 hover:text-red-600"
              title="Eliminar este mensaje">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
        </svg>
      </button>

      <!-- Eliminar hacia arriba -->
      <button
              hx-post="{% url 'delete_messages_upwards' message.id %}"
              hx-confirm="¡Atención! Se eliminará este mensaje Y TODOS los anteriores en esta conversación. ¿Continuar?"
              class="p-1 text-gray-400 hover:text-red-600"
              title="Eliminar este y los anteriores">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 11l7-7 7 7M5 19l7-7 7 7" />
        </svg>
      </button>
    </div>

    <!-- Globo -->
    <div class="message-bubble inline-block max-w-full lg:max-w-3xl xl:max-w-4xl px-4 py-2 rounded-2xl
      {% if message.role == 'user' %}order-1{% endif %}
      {% if message.role == 'user' %}
        bg-gradient-to-br from-blue-600 to-blue-500 text-white shadow-sm rounded-tr-none
      {% else %}
        bg-white/90 text-gray-900 dark:bg-gray-800/90 dark:text-gray-100 shadow border border-gray-200 dark:border-gray-700 rounded-tl-none backdrop-blur
      {% endif %}">
      {% load chat_extras %}
      <div class="prose prose-sm dark:prose-invert max-w-none markdown-content
            leading-[1.35] break-words
            prose-p:my-1 prose-ul:my-1.5 prose-ol:my-1.5 prose-li:my-0.5 prose-pre:my-2"
           data-role="{{ message.role }}">
        {{ message.content|safe }}
      </div>
    </div>

  </div>
</div>
