<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>AGENTE IA - ECONOMIC</title>
  {% load static %}

  <!-- Aplica tema antes de pintar (evita parpadeo) -->
  <script>
    (function() {
      try {
        var theme = localStorage.getItem('theme');
        var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (theme === 'dark' || (!theme && prefersDark)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      } catch (e) {}
    })();
  </script>

  <!-- Tailwind: darkMode='class' antes del CDN -->
  <script>
    window.tailwind = window.tailwind || {};
    window.tailwind.config = { darkMode: 'class' };
  </script>

  <!-- Fuente profesional + Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htmx.org@1.9.6"></script>

  <!-- Markdown & sanitizaci√≥n -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <style>
    /* Tipograf√≠a & Markdown */
    html, body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"; }
    .markdown-content p{ text-align: justify; white-space: pre-line; }
    .markdown-content ul{ list-style: disc; padding-left: 1.2rem; }
    .markdown-content ol{ list-style: decimal; padding-left: 1.2rem; }
    .markdown-content pre{ white-space: pre; }
    .markdown-content pre.code-dark{
      background-color:#111827; /* gray-900 */
      color:#e5e7eb; /* gray-200 */
      padding:1rem; border-radius:0.75rem; overflow-x:auto;
    }
    .markdown-content pre.code-dark code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* Scrollbar sutil */
    *::-webkit-scrollbar{ width:10px; height:10px; }
    *::-webkit-scrollbar-track{ background: transparent; }
    *::-webkit-scrollbar-thumb{
      background: rgba(107,114,128,.35); /* gray-500/35 */
      border-radius: 999px;
      border: 2px solid transparent;
      background-clip: content-box;
    }
    *::-webkit-scrollbar-thumb:hover{ background: rgba(107,114,128,.6); }
  </style>
</head>

<body class="bg-gray-100 dark:bg-gray-950 text-gray-900 dark:text-gray-100 antialiased">
<div class="flex h-screen">

  <!-- Sidebar -->
  <aside class="w-80 shrink-0 bg-white/90 dark:bg-gray-900/90 backdrop-blur shadow-sm border-r border-gray-200 dark:border-gray-800 flex flex-col">
    <!-- Brand -->
    <div class="p-4 border-b border-gray-200 dark:border-gray-800">
      <a href="{% url 'chat_list' %}" class="flex items-center gap-3 group" aria-label="Inicio">
        <img src="{% static 'images/logo.png' %}" alt="Migraciones Per√∫"
             class="h-9 w-auto object-contain select-none" loading="eager" decoding="async">
        <div class="leading-tight">
          <span class="block text-sm font-semibold tracking-wide text-gray-900 dark:text-gray-100 group-hover:text-blue-600">Agente IA ¬∑ ECONOMIC</span>
          <span class="block text-xs text-gray-500 dark:text-gray-400">Suite Conversacional</span>
        </div>
      </a>
    </div>

    <!-- Acciones -->
    <div class="flex-1 p-3 overflow-y-auto">
      <!-- Nueva conversaci√≥n -->
      <div class="mb-3">
        {% if all_conversations_count < 10 %}
        <form action="{% url 'new_conversation' %}" method="post">
          {% csrf_token %}
          <button type="submit"
                  class="w-full px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 active:scale-[.99] transition flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M19 11H13V5h-2v6H5v2h6v6h2v-6h6z"/></svg>
            Nueva conversaci√≥n
          </button>
        </form>
        {% else %}
        <button disabled
                class="w-full px-3 py-2 rounded-lg bg-gray-400 text-white cursor-not-allowed flex items-center justify-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M19 11H13V5h-2v6H5v2h6v6h2v-6h6z"/></svg>
          L√≠mite alcanzado (10)
        </button>
        {% endif %}
      </div>

      {% if can_save and conversation %}
      <div class="mb-4">
        <button id="btn-save-conv"
                class="w-full px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition"
                data-conv-id="{{ conversation.id }}"
                data-save-url="{% url 'save_conversation' %}"
                disabled>
          üíæ Guardar conversaci√≥n
        </button>
      </div>
      {% endif %}

      <!-- Crear carpeta -->
      <div class="mb-4">
        <form action="{% url 'create_folder' %}" method="post" class="flex gap-2">
          {% csrf_token %}
          <input type="text" name="folder_name" placeholder="Nueva carpeta‚Ä¶"
                 class="flex-1 px-3 py-2 text-sm border rounded-lg bg-gray-50 dark:bg-gray-800 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <button type="submit"
                  class="px-3 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Crear</button>
        </form>
      </div>

      <!-- Carpetas -->
      {% for folder in folders %}
      <details class="group mb-1" open>
        <summary class="px-2 py-1 rounded-md font-medium text-gray-700 dark:text-gray-300 cursor-pointer flex items-center justify-between hover:bg-gray-100 dark:hover:bg-gray-800">
          <div class="flex-1" id="folder-display-{{ folder.id }}">
            <span class="folder-name">{{ folder.name }}</span>
          </div>
          <form id="folder-edit-form-{{ folder.id }}" action="{% url 'edit_folder' folder.id %}" method="post" class="hidden flex-1">
            {% csrf_token %}
            <input type="text" name="new_folder_name" value="{{ folder.name }}"
                   class="w-full text-sm bg-gray-100 dark:bg-gray-700 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
          </form>

          <div class="ml-2 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
            <button onclick="toggleEdit('folder', {{ folder.id }})" class="p-1 hover:text-blue-600" title="Editar nombre">
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
            </button>
            <form action="{% url 'delete_folder' folder.id %}" method="post" onsubmit="return confirm('¬øEliminar la carpeta \"{{ folder.name }}\" y sus conversaciones?');">
            {% csrf_token %}
            <button type="submit" class="p-1 hover:text-red-600" title="Eliminar carpeta">
              <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
            </button>
            </form>
          </div>
        </summary>

        <div class="pl-3">
          {% for conv in folder.conversations.all %}
          {% include 'chat/_conversation_item.html' with conv=conv %}
          {% empty %}
          <p class="px-4 py-2 text-xs text-gray-500">Carpeta vac√≠a</p>
          {% endfor %}
        </div>
      </details>
      {% endfor %}

      <!-- Conversaciones sin carpeta -->
      <div class="mt-4">
        <h3 class="px-2 mb-1 text-xs font-semibold tracking-wide uppercase text-gray-500 dark:text-gray-400">Conversaciones</h3>
        {% for conv in conversations_without_folder %}
        {% include 'chat/_conversation_item.html' with conv=conv %}
        {% endfor %}
      </div>
    </div>

    <!-- Footer usuario -->
    <div class="p-3 border-t border-gray-200 dark:border-gray-800 mt-auto">
      <div class="bg-gray-50/70 dark:bg-gray-800/70 rounded-lg shadow-sm overflow-hidden">
        <a href="{% url 'profile' %}" class="w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">
            <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-blue-600 text-white font-semibold">
              {{ request.user.first_name|default:request.user.username|slice:":1"|upper }}
            </span>
          <span class="flex-1 truncate">
              {{ request.user.first_name }} {{ request.user.last_name }}
            </span>
        </a>
        <button type="button" id="toggle-theme" class="w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M21.64 13.64A9 9 0 1 1 10.36 2.36 7 7 0 0 0 21.64 13.64z"/></svg>
          <span>Alternar tema</span>
        </button>
        <a href="{% url 'logout' %}" class="w-full flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-gray-100 dark:hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M16 13v-2H7V8l-5 4 5 4v-3h9zM20 3h-8v2h8v14h-8v2h8a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"/></svg>
          <span>Cerrar sesi√≥n</span>
        </a>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 flex flex-col bg-white dark:bg-gray-950">
    {% if messages %}
    <div id="global-alerts" class="p-4 space-y-2">
      {% for message in messages %}
      <div class="text-sm rounded px-3 py-2
            {% if message.tags == 'error' %} bg-red-100 text-red-800
            {% elif message.tags == 'success' %} bg-green-100 text-green-800
            {% elif message.tags == 'warning' %} bg-yellow-100 text-yellow-800
            {% else %} bg-blue-100 text-blue-800 {% endif %}">
        {{ message }}
      </div>
      {% endfor %}
    </div>
    {% endif %}

    {% block content %}{% endblock %}
  </main>
</div>

<!-- Scripts existentes + peque√±os retoques -->
<script>
  (function(){
    // Auto-cerrar alertas
    const alerts = document.getElementById('global-alerts');
    if (alerts) { setTimeout(() => alerts.remove(), 4000); }

    // HTMX + CSRF
    document.body.addEventListener('htmx:configRequest', function(event) {
      event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
    });

    function applyBodyBg() {
      if (document.documentElement.classList.contains('dark')) {
        document.body.classList.add('bg-gray-950');
      } else {
        document.body.classList.remove('bg-gray-950');
      }
    }

    const btn = document.getElementById('toggle-theme');
    if (btn) {
      btn.addEventListener('click', function(){
        const isDark = document.documentElement.classList.toggle('dark');
        try { localStorage.setItem('theme', isDark ? 'dark' : 'light'); } catch(e) {}
        applyBodyBg();
      });
    }

    try {
      const m = window.matchMedia('(prefers-color-scheme: dark)');
      m.addEventListener && m.addEventListener('change', function(e){
        const saved = localStorage.getItem('theme');
        if (!saved) {
          if (e.matches) document.documentElement.classList.add('dark');
          else document.documentElement.classList.remove('dark');
          applyBodyBg();
        }
      });
    } catch(e) {}

    applyBodyBg();
  })();

  // Mantener toggleEdit tal cual
  function toggleEdit(type, id) {
    const displayEl = document.getElementById(`${type}-display-${id}`);
    const formEl = document.getElementById(`${type}-edit-form-${id}`);
    const isHidden = formEl.classList.contains('hidden');
    if (isHidden) {
      displayEl.classList.add('hidden');
      formEl.classList.remove('hidden');
      formEl.querySelector('input').focus();
    } else {
      displayEl.classList.remove('hidden');
      formEl.classList.add('hidden');
    }
  }
</script>

<script>
  (function(){
    // ---------- selecci√≥n user/bot para "Guardar conversaci√≥n" (sin cambios funcionales)
    function getCsrfFromCookie(){ const m=document.cookie.match(/csrftoken=([^;]+)/); return m?m[1]:''; }
    function isUserRole(role){ role=(role||'').toLowerCase(); return role==='user'||role==='human'; }
    function isBotRole(role){ role=(role||'').toLowerCase(); return role==='assistant'||role==='bot'; }
    function findChecks(){ return Array.from(document.querySelectorAll('.save-select')); }

    function enforceSelection(){
      const checks = findChecks().filter(c=>c.checked);
      const users = checks.filter(c=>isUserRole(c.dataset.role));
      const bots  = checks.filter(c=>isBotRole(c.dataset.role));
      users.slice(1).forEach(c => c.checked = false);
      bots.slice(1).forEach(c => c.checked = false);

      const selectedUser = users[0]?.dataset.id || null;
      const selectedBot  = bots[0]?.dataset.id  || null;

      const btn = document.getElementById('btn-save-conv');
      if (btn){
        btn.disabled = !(selectedUser && selectedBot);
        btn.dataset.userId = selectedUser || '';
        btn.dataset.botId  = selectedBot  || '';
      }
    }

    document.addEventListener('change', function(e){
      if (e.target?.classList?.contains('save-select')) enforceSelection();
    });

    document.body.addEventListener('htmx:afterSwap', enforceSelection);

    document.addEventListener('click', async function(e){
      const btn = e.target.closest('#btn-save-conv');
      if (!btn) return;
      const convId = btn.dataset.convId;
      const userId = btn.dataset.userId;
      const botId  = btn.dataset.botId;
      const url    = btn.dataset.saveUrl;
      if (!convId || !userId || !botId || !url) return;

      btn.disabled = true;
      const prev = btn.textContent;
      btn.textContent = 'Guardando‚Ä¶';

      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfFromCookie(),
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: JSON.stringify({
            conversation_id: Number(convId),
            user_message_id: Number(userId),
            bot_message_id: Number(botId)
          })
        });
        const data = await res.json();
        if (data.ok){
          alert('¬°Conversaci√≥n guardada en n8n!');
          findChecks().forEach(c => c.checked = false);
          enforceSelection();
        } else {
          alert('No se pudo guardar: ' + (data.error || (res.status + ' ' + res.statusText)));
        }
      } catch (err){
        alert('Error de red: ' + err);
      } finally {
        btn.textContent = prev;
        enforceSelection();
      }
    });

    enforceSelection();
  })();
</script>
<script>
  (function(){
    const SELECTOR = 'select.expand-on-focus';
    const getExpandClass = (el) => el.dataset.expandClass || '!w-56';

    function expand(el){
      el.classList.add(getExpandClass(el));
    }
    function collapse(el){
      el.classList.remove(getExpandClass(el));
    }
    function collapseAll(except){
      document.querySelectorAll(SELECTOR).forEach(s => {
        if (except && s === except) return;
        collapse(s);
      });
    }

    // Expandir al enfocar o mousedown (antes de que abra el men√∫)
    document.addEventListener('focusin', (e) => {
      if (e.target.matches(SELECTOR)) expand(e.target);
    });
    document.addEventListener('mousedown', (e) => {
      if (e.target.matches(SELECTOR)) {
        expand(e.target);
      } else {
        // Click fuera => colapsar
        collapseAll();
      }
    });

    // Colapsar al perder foco, al cambiar o con Escape
    document.addEventListener('focusout', (e) => {
      if (e.target.matches(SELECTOR)) collapse(e.target);
    });
    document.addEventListener('change', (e) => {
      if (e.target.matches(SELECTOR)) collapse(e.target);
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') collapseAll();
    });

    // Si usas HTMX y se re-renderiza el item, nada extra: los listeners son globales.
    document.body.addEventListener && document.body.addEventListener('htmx:afterSwap', () => {
      // (Opcional) Asegura que todos inicien colapsados
      collapseAll();
    });
  })();
</script>
<script>
  (function(){
    function findBubbleFromButton(btn){
      // Busca el contenedor del mensaje y luego el globo
      const wrap = btn.closest('[id^="message-"]');
      return wrap ? wrap.querySelector('.message-bubble') : null;
    }

    async function copyText(text){
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch {
        // Fallback para navegadores antiguos / permisos denegados
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.focus(); ta.select();
        let ok = false;
        try { ok = document.execCommand('copy'); } catch {}
        document.body.removeChild(ta);
        return ok;
      }
    }

    function flashOk(btn){
      const previous = btn.innerHTML, previousTitle = btn.title;
      // icono check
      btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2l-3.5-3.6-1.4 1.4L9 19 20.3 7.7l-1.4-1.4z"/></svg>';
      btn.title = 'Copiado';
      btn.classList.add('text-emerald-600');
      setTimeout(()=>{ btn.innerHTML = previous; btn.title = previousTitle; btn.classList.remove('text-emerald-600'); }, 1200);
    }

    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('.btn-copy-bubble');
      if (!btn) return;
      const bubble = findBubbleFromButton(btn);
      if (!bubble) return;
      const text = (bubble.innerText || bubble.textContent || '').trim();
      if (!text) return;
      const ok = await copyText(text);
      if (ok) flashOk(btn);
    });

    // Si HTMX re-renderiza mensajes, no pasa nada: delegaci√≥n global.
  })();
</script>

</body>
</html>
