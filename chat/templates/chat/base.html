<!DOCTYPE html>
<html class="h-full" lang="es">
<head>
  <meta charset="UTF-8" />
  <title>AGENTE IA - CONTABLE</title>
  {% load static %}

  <!-- Aplica tema antes de pintar (evita parpadeo) -->
  <script>
    (function() {
      try {
        var theme = localStorage.getItem('theme');
        var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (theme === 'dark' || (!theme && prefersDark)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      } catch (e) {}
    })();
  </script>

  <!-- Tailwind: darkMode='class' antes del CDN -->
  <script>
    window.tailwind = window.tailwind || {};
    window.tailwind.config = { darkMode: 'class' };
  </script>

  <!-- Fuente profesional + Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htmx.org@1.9.6"></script>

  <!-- Markdown & sanitización -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <style>
    :root{
      /* Paleta UNMSM */
      --brand-900:#401517;
      --brand-800:#541C1F;
      --brand-700:#66272A; /* guinda */
      --brand-600:#7A3135;
      --brand-500:#AF7766; /* terracota */
      --brand-400:#C99488;
      --brand-300:#D6ADA0;
      --brand-200:#E6C8BC;
      --brand-100:#F1DED7;
      --brand-50:#FAF0EC;

      --paper-50:#E1D4C2;   /* arena suave */
      --paper-100:#D5C2AC;  /* arena media */
      --muted-100:#E5E4E3;  /* gris cálido */
      --accent-600:#E87E36; /* naranja detalle */
    }

    /* Remapeo de “azules” Tailwind → paleta UNMSM */
    .bg-blue-600{background-color:var(--brand-600)!important;}
    .hover\:bg-blue-700:hover{background-color:var(--brand-700)!important;}
    .active\:bg-blue-700:active{background-color:var(--brand-700)!important;}
    .text-blue-600{color:var(--brand-600)!important;}
    .bg-blue-50{background-color:var(--brand-50)!important;}
    .focus\:ring-blue-600:focus{--tw-ring-color:var(--brand-600)!important;}
    .ring-blue-500\/20{--tw-ring-color:rgba(175,119,102,.20)!important;}
    .group:hover .group-hover\:text-blue-600{color:var(--brand-600)!important;}

    /* Gradientes que usas en globos/btns */
    .from-blue-600{
      --tw-gradient-from:var(--brand-600)!important;
      --tw-gradient-to:rgb(122 49 53 / 0)!important;
      --tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to)!important;
    }
    .to-blue-500{ --tw-gradient-to:var(--brand-500)!important; }

    /* (Opcional) Fondos cálidos tipo papel en vez de gris */
    /* .bg-gray-50{background-color:var(--paper-50)!important;} */
    /* .dark .bg-gray-50{background-color:#0b0b0e!important;} */

    /* Utilidades pequeñas de acento naranja (por si las quieres usar) */
    .text-accent{color:var(--accent-600);}
    .bg-accent{background-color:var(--accent-600);}
    /* Quita márgenes extremos del primer y último hijo dentro del globo */
    .markdown-content > :first-child { margin-top: 0 !important; }
    .markdown-content > :last-child  { margin-bottom: 0 !important; }

    /* Si (aún) el PRIMER hijo es un <pre>, haz que se vea como texto normal */
    .markdown-content > pre:first-child {
      background: transparent !important;
      color: inherit !important;
      padding: 0 !important;
      margin: 0 !important;
      border: 0 !important;
      box-shadow: none !important;
      overflow: visible !important;
    }
    .markdown-content > pre:first-child code {
      white-space: pre-wrap !important;
      display: block !important;
      font-family: inherit !important;
      font-size: inherit !important;
      color: inherit !important;
    }

  </style>

</head>

<body class="h-full overflow-hidden bg-gray-100 dark:bg-gray-950 text-gray-900 dark:text-gray-100 antialiased">

<!-- Botón flotante para ABRIR el sidebar -->
<button id="btn-open-sidebar"
        class="hidden fixed top-3 left-3 z-40 p-2 rounded-xl bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 shadow hover:bg-gray-50 dark:hover:bg-gray-800"
        title="Mostrar panel">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
    <path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/>
  </svg>
</button>

<div class="flex h-screen">
  <!-- Sidebar -->
  <aside id="sidebar"
         class="w-80 shrink-0 bg-white/90 dark:bg-gray-900/90 backdrop-blur shadow-sm border-r border-gray-200 dark:border-gray-800 flex flex-col transition-all duration-200 ease-out">

    <!-- Brand -->
    <div class="p-4 border-b border-gray-200 dark:border-gray-800">
      <div class="flex items-center justify-between">
        <a href="{% url 'chat_list' %}" class="flex items-center gap-3 group" aria-label="Inicio">
          <img src="{% static 'images/logo.png' %}" alt="IA-ECONOMICS"
               class="h-20 w-auto object-contain select-none" loading="eager" decoding="async">
          <div class="leading-tight">
            <span class="block text-sm font-semibold tracking-wide text-gray-900 dark:text-gray-100 group-hover:text-blue-600">Agente IA · CONTABLE</span>
            <span class="block text-xs text-gray-500 dark:text-gray-400">CHATS </span>
          </div>
        </a>

        <!-- Botón para CERRAR el sidebar -->
        <button id="btn-close-sidebar"
                class="group p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800"
                title="Ocultar panel" aria-label="Ocultar panel">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor"
               xmlns="http://www.w3.org/2000/svg"
               data-rtl-flip=""
               class="h-5 w-5 text-gray-600 dark:text-gray-300 transition-transform duration-200 group-hover:rotate-90">
            <path d="M6.83496 3.99992C6.38353 4.00411 6.01421 4.0122 5.69824 4.03801C5.31232 4.06954 5.03904 4.12266 4.82227 4.20012L4.62207 4.28606C4.18264 4.50996 3.81498 4.85035 3.55859 5.26848L3.45605 5.45207C3.33013 5.69922 3.25006 6.01354 3.20801 6.52824C3.16533 7.05065 3.16504 7.71885 3.16504 8.66301V11.3271C3.16504 12.2712 3.16533 12.9394 3.20801 13.4618C3.25006 13.9766 3.33013 14.2909 3.45605 14.538L3.55859 14.7216C3.81498 15.1397 4.18266 15.4801 4.62207 15.704L4.82227 15.79C5.03904 15.8674 5.31234 15.9205 5.69824 15.9521C6.01398 15.9779 6.383 15.986 6.83398 15.9902L6.83496 3.99992ZM18.165 11.3271C18.165 12.2493 18.1653 12.9811 18.1172 13.5702C18.0745 14.0924 17.9916 14.5472 17.8125 14.9648L17.7295 15.1415C17.394 15.8 16.8834 16.3511 16.2568 16.7353L15.9814 16.8896C15.5157 17.1268 15.0069 17.2285 14.4102 17.2773C13.821 17.3254 13.0893 17.3251 12.167 17.3251H7.83301C6.91071 17.3251 6.17898 17.3254 5.58984 17.2773C5.06757 17.2346 4.61294 17.1508 4.19531 16.9716L4.01855 16.8896C3.36014 16.5541 2.80898 16.0434 2.4248 15.4169L2.27051 15.1415C2.03328 14.6758 1.93158 14.167 1.88281 13.5702C1.83468 12.9811 1.83496 12.2493 1.83496 11.3271V8.66301C1.83496 7.74072 1.83468 7.00898 1.88281 6.41985C1.93157 5.82309 2.03329 5.31432 2.27051 4.84856L2.4248 4.57317C2.80898 3.94666 3.36012 3.436 4.01855 3.10051L4.19531 3.0175C4.61285 2.83843 5.06771 2.75548 5.58984 2.71281C6.17898 2.66468 6.91071 2.66496 7.83301 2.66496H12.167C13.0893 2.66496 13.821 2.66468 14.4102 2.71281C15.0069 2.76157 15.5157 2.86329 15.9814 3.10051L16.2568 3.25481C16.8833 3.63898 17.394 4.19012 17.7295 4.84856L17.8125 5.02531C17.9916 5.44285 18.0745 5.89771 18.1172 6.41985C18.1653 7.00898 18.165 7.74072 18.165 8.66301V11.3271ZM8.16406 15.995H12.167C13.1112 15.995 13.7794 15.9947 14.3018 15.9521C14.8164 15.91 15.1308 15.8299 15.3779 15.704L15.5615 15.6015C15.9797 15.3451 16.32 14.9774 16.5439 14.538L16.6299 14.3378C16.7074 14.121 16.7605 13.8478 16.792 13.4618C16.8347 12.9394 16.835 12.2712 16.835 11.3271V8.66301C16.835 7.71885 16.8347 7.05065 16.792 6.52824C16.7605 6.14232 16.7073 5.86904 16.6299 5.65227L16.5439 5.45207C16.32 5.01264 15.9796 4.64498 15.5615 4.3886L15.3779 4.28606C15.1308 4.16013 14.8165 4.08006 14.3018 4.03801C13.7794 3.99533 13.1112 3.99504 12.167 3.99504H8.16406C8.16407 3.99667 8.16504 3.99829 8.16504 3.99992L8.16406 15.995Z"></path>
          </svg>
        </button>
      </div>
    </div>


    <!-- Acciones -->
    <div class="flex-1 p-3 overflow-y-auto">
      <!-- Nueva conversación -->
      <div class="mb-3">
        {% if all_conversations_count < 10 %}
        <form action="{% url 'new_conversation' %}" method="post">
          {% csrf_token %}
          <button type="submit"
                  class="w-full px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 active:scale-[.99] transition flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M19 11H13V5h-2v6H5v2h6v6h2v-6h6z"/></svg>
            Nueva conversación
          </button>
        </form>
        {% else %}
        <button disabled
                class="w-full px-3 py-2 rounded-lg bg-gray-400 text-white cursor-not-allowed flex items-center justify-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M19 11H13V5h-2v6H5v2h6v6h2v-6h6z"/></svg>
          Límite alcanzado (10)
        </button>
        {% endif %}
      </div>

      {% if can_save and conversation %}
      <div class="mb-4">
        <button id="btn-save-conv"
                class="w-full px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition"
                data-conv-id="{{ conversation.id }}"
                data-save-url="{% url 'save_conversation' %}"
                disabled>
          💾 Guardar conversación
        </button>
      </div>
      {% endif %}

      <!-- Crear carpeta -->
      <div class="mb-4">
        <form action="{% url 'create_folder' %}" method="post" class="flex gap-2">
          {% csrf_token %}
          <input type="text" name="folder_name" placeholder="Nueva carpeta…"
                 class="flex-1 px-3 py-2 text-sm border rounded-lg bg-gray-50 dark:bg-gray-800 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <button type="submit"
                  class="px-3 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Crear</button>
        </form>
      </div>

      <!-- Carpetas -->
      {% for folder in folders %}
      <details
              class="group"
              data-folder-id="{{ folder.id }}"
      >
        <!-- <details class="group" data-folder-id="{{ folder.id }}"> -->
        <summary class="group/row px-2 py-1 rounded-md font-medium text-gray-700 dark:text-gray-300 cursor-pointer flex items-center justify-between hover:bg-gray-100 dark:hover:bg-gray-800">

          <!-- Izquierda: icono + nombre (flex-1) -->
          <div class="flex items-center gap-2 flex-1" id="folder-display-{{ folder.id }}">
            <!-- Contenedor tipo GPT del icono -->
            <span class="flex h-6 w-6 items-center justify-center rounded-md bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-300 shrink-0">
      <!-- Carpeta CERRADA -->
      <svg class="h-4 w-4 group-open:hidden" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M3 7a2 2 0 0 1 2-2h4l2 2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"/>
      </svg>
              <!-- Carpeta ABIERTA -->
      <svg class="h-4 w-4 hidden group-open:inline" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M2.8 10.6A2 2 0 0 1 4.6 9h6.9a2 2 0 0 1 1.9 1.3l.15.41h4.95a2 2 0 0 1 1.9 2.6l-1.11 3.32A3 3 0 0 1 17.4 19H6.43a3 3 0 0 1-2.83-1.98L2.6 12.53a2 2 0 0 1 .2-1.93zM4 7a2 2 0 0 1 2-2h3.5l1.5 1.5H14a2 2 0 0 1 2 2v1H4V7z"/>
      </svg>
    </span>

            <span class="truncate folder-name">{{ folder.name }}</span>
          </div>

          <!-- Form de edición (lo conservas tal cual) -->
          <form id="folder-edit-form-{{ folder.id }}"
                action="{% url 'edit_folder' folder.id %}"
                method="post"
                class="hidden flex-1">
            {% csrf_token %}
            <input type="text" name="new_folder_name" value="{{ folder.name }}"
                   class="w-full text-sm bg-gray-100 dark:bg-gray-700 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
          </form>

          <!-- Acciones (se muestran al hover del summary) -->
          <div class="ml-2 flex items-center gap-1 opacity-0 transition group-hover/row:opacity-100 focus-within:opacity-100">
            <button onclick="toggleEdit('folder', {{ folder.id }})" class="p-1 hover:text-blue-600" title="Editar nombre">
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"/>
              </svg>
            </button>
            <form action="{% url 'delete_folder' folder.id %}" method="post"
                  onsubmit="return confirm('¿Eliminar la carpeta &quot;{{ folder.name }}&quot; y sus conversaciones?');">
              {% csrf_token %}
              <button type="submit" class="p-1 hover:text-red-600" title="Eliminar carpeta">
                <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                        d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z"
                        clip-rule="evenodd"></path>
                </svg>
              </button>
            </form>
          </div>
        </summary>


        <div class="pl-3">
          {% for conv in folder.conversations.all %}
          {% include 'chat/_conversation_item.html' with conv=conv %}
          {% empty %}
          <p class="px-4 py-2 text-xs text-gray-500">Carpeta vacía</p>
          {% endfor %}
        </div>
      </details>
      {% endfor %}

      <!-- Conversaciones sin carpeta -->
      <div class="mt-4">
        <h3 class="px-2 mb-1 text-xs font-semibold tracking-wide uppercase text-gray-500 dark:text-gray-400">Conversaciones</h3>
        {% for conv in conversations_without_folder %}
        {% include 'chat/_conversation_item.html' with conv=conv %}
        {% endfor %}
      </div>
    </div>

    <!-- Footer usuario -->
    <div class="p-3 border-t border-gray-200 dark:border-gray-800 mt-auto">
      <div class="bg-gray-50/70 dark:bg-gray-800/70 rounded-lg shadow-sm overflow-hidden">
        <a href="{% url 'profile' %}" class="w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">
            <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-blue-600 text-white font-semibold">
              {{ request.user.first_name|default:request.user.username|slice:":1"|upper }}
            </span>
          <span class="flex-1 truncate">
              {{ request.user.first_name }} {{ request.user.last_name }}
            </span>
        </a>
        <button type="button" id="toggle-theme" class="w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M21.64 13.64A9 9 0 1 1 10.36 2.36 7 7 0 0 0 21.64 13.64z"/></svg>
          <span>Alternar tema</span>
        </button>
        <a href="{% url 'logout' %}" class="w-full flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-gray-100 dark:hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M16 13v-2H7V8l-5 4 5 4v-3h9zM20 3h-8v2h8v14h-8v2h8a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"/></svg>
          <span>Cerrar sesión</span>
        </a>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 flex flex-col bg-white dark:bg-gray-950">
    {% if messages %}
    <div id="global-alerts" class="p-4 space-y-2">
      {% for message in messages %}
      <div class="text-sm rounded px-3 py-2
            {% if message.tags == 'error' %} bg-red-100 text-red-800
            {% elif message.tags == 'success' %} bg-green-100 text-green-800
            {% elif message.tags == 'warning' %} bg-yellow-100 text-yellow-800
            {% else %} bg-blue-100 text-blue-800 {% endif %}">
        {{ message }}
      </div>
      {% endfor %}
    </div>
    {% endif %}

    {% block content %}{% endblock %}
  </main>
</div>

<!-- Scripts existentes + pequeños retoques -->
<script>
  (function(){
    // Auto-cerrar alertas
    const alerts = document.getElementById('global-alerts');
    if (alerts) { setTimeout(() => alerts.remove(), 4000); }

    // HTMX + CSRF
    document.body.addEventListener('htmx:configRequest', function(event) {
      event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
    });

    function applyBodyBg() {
      if (document.documentElement.classList.contains('dark')) {
        document.body.classList.add('bg-gray-950');
      } else {
        document.body.classList.remove('bg-gray-950');
      }
    }

    const btn = document.getElementById('toggle-theme');
    if (btn) {
      btn.addEventListener('click', function(){
        const isDark = document.documentElement.classList.toggle('dark');
        try { localStorage.setItem('theme', isDark ? 'dark' : 'light'); } catch(e) {}
        applyBodyBg();
      });
    }

    try {
      const m = window.matchMedia('(prefers-color-scheme: dark)');
      m.addEventListener && m.addEventListener('change', function(e){
        const saved = localStorage.getItem('theme');
        if (!saved) {
          if (e.matches) document.documentElement.classList.add('dark');
          else document.documentElement.classList.remove('dark');
          applyBodyBg();
        }
      });
    } catch(e) {}

    applyBodyBg();
  })();

  // Mantener toggleEdit tal cual
  function toggleEdit(type, id) {
    const displayEl = document.getElementById(`${type}-display-${id}`);
    const formEl = document.getElementById(`${type}-edit-form-${id}`);
    const isHidden = formEl.classList.contains('hidden');
    if (isHidden) {
      displayEl.classList.add('hidden');
      formEl.classList.remove('hidden');
      formEl.querySelector('input').focus();
    } else {
      displayEl.classList.remove('hidden');
      formEl.classList.add('hidden');
    }
  }
</script>

<script>
  (function(){
    // ---------- selección user/bot para "Guardar conversación" (sin cambios funcionales)
    function getCsrfFromCookie(){ const m=document.cookie.match(/csrftoken=([^;]+)/); return m?m[1]:''; }
    function isUserRole(role){ role=(role||'').toLowerCase(); return role==='user'||role==='human'; }
    function isBotRole(role){ role=(role||'').toLowerCase(); return role==='assistant'||role==='bot'; }
    function findChecks(){ return Array.from(document.querySelectorAll('.save-select')); }

    function enforceSelection(){
      const checks = findChecks().filter(c=>c.checked);
      const users = checks.filter(c=>isUserRole(c.dataset.role));
      const bots  = checks.filter(c=>isBotRole(c.dataset.role));
      users.slice(1).forEach(c => c.checked = false);
      bots.slice(1).forEach(c => c.checked = false);

      const selectedUser = users[0]?.dataset.id || null;
      const selectedBot  = bots[0]?.dataset.id  || null;

      const btn = document.getElementById('btn-save-conv');
      if (btn){
        btn.disabled = !(selectedUser && selectedBot);
        btn.dataset.userId = selectedUser || '';
        btn.dataset.botId  = selectedBot  || '';
      }
    }

    document.addEventListener('change', function(e){
      if (e.target?.classList?.contains('save-select')) enforceSelection();
    });

    document.body.addEventListener('htmx:afterSwap', enforceSelection);

    document.addEventListener('click', async function(e){
      const btn = e.target.closest('#btn-save-conv');
      if (!btn) return;
      const convId = btn.dataset.convId;
      const userId = btn.dataset.userId;
      const botId  = btn.dataset.botId;
      const url    = btn.dataset.saveUrl;
      if (!convId || !userId || !botId || !url) return;

      btn.disabled = true;
      const prev = btn.textContent;
      btn.textContent = 'Guardando…';

      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfFromCookie(),
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: JSON.stringify({
            conversation_id: Number(convId),
            user_message_id: Number(userId),
            bot_message_id: Number(botId)
          })
        });
        const data = await res.json();
        if (data.ok){
          alert('¡Conversación guardada en n8n!');
          findChecks().forEach(c => c.checked = false);
          enforceSelection();
        } else {
          alert('No se pudo guardar: ' + (data.error || (res.status + ' ' + res.statusText)));
        }
      } catch (err){
        alert('Error de red: ' + err);
      } finally {
        btn.textContent = prev;
        enforceSelection();
      }
    });

    enforceSelection();
  })();
</script>
<script>
  (function(){
    const SELECTOR = 'select.expand-on-focus';
    const getExpandClass = (el) => el.dataset.expandClass || '!w-56';

    function expand(el){
      el.classList.add(getExpandClass(el));
    }
    function collapse(el){
      el.classList.remove(getExpandClass(el));
    }
    function collapseAll(except){
      document.querySelectorAll(SELECTOR).forEach(s => {
        if (except && s === except) return;
        collapse(s);
      });
    }

    // Expandir al enfocar o mousedown (antes de que abra el menú)
    document.addEventListener('focusin', (e) => {
      if (e.target.matches(SELECTOR)) expand(e.target);
    });
    document.addEventListener('mousedown', (e) => {
      if (e.target.matches(SELECTOR)) {
        expand(e.target);
      } else {
        // Click fuera => colapsar
        collapseAll();
      }
    });

    // Colapsar al perder foco, al cambiar o con Escape
    document.addEventListener('focusout', (e) => {
      if (e.target.matches(SELECTOR)) collapse(e.target);
    });
    document.addEventListener('change', (e) => {
      if (e.target.matches(SELECTOR)) collapse(e.target);
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') collapseAll();
    });

    // Si usas HTMX y se re-renderiza el item, nada extra: los listeners son globales.
    document.body.addEventListener && document.body.addEventListener('htmx:afterSwap', () => {
      // (Opcional) Asegura que todos inicien colapsados
      collapseAll();
    });
  })();
</script>
<script>
  (function(){
    function findBubbleFromButton(btn){
      // Busca el contenedor del mensaje y luego el globo
      const wrap = btn.closest('[id^="message-"]');
      return wrap ? wrap.querySelector('.message-bubble') : null;
    }

    async function copyText(text){
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch {
        // Fallback para navegadores antiguos / permisos denegados
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.focus(); ta.select();
        let ok = false;
        try { ok = document.execCommand('copy'); } catch {}
        document.body.removeChild(ta);
        return ok;
      }
    }

    function flashOk(btn){
      const previous = btn.innerHTML, previousTitle = btn.title;
      // icono check
      btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2l-3.5-3.6-1.4 1.4L9 19 20.3 7.7l-1.4-1.4z"/></svg>';
      btn.title = 'Copiado';
      btn.classList.add('text-emerald-600');
      setTimeout(()=>{ btn.innerHTML = previous; btn.title = previousTitle; btn.classList.remove('text-emerald-600'); }, 1200);
    }

    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('.btn-copy-bubble');
      if (!btn) return;
      const bubble = findBubbleFromButton(btn);
      if (!bubble) return;
      const text = (bubble.innerText || bubble.textContent || '').trim();
      if (!text) return;
      const ok = await copyText(text);
      if (ok) flashOk(btn);
    });

    // Si HTMX re-renderiza mensajes, no pasa nada: delegación global.
  })();
</script>
<script>
  (function(){
    const sidebar = document.getElementById('sidebar');
    const openBtn = document.getElementById('btn-open-sidebar');
    const closeBtn = document.getElementById('btn-close-sidebar');
    const LS_KEY = 'sidebar:collapsed';

    function setCollapsed(collapsed){
      if (!sidebar || !openBtn) return;
      if (collapsed){
        sidebar.classList.add('hidden');
        openBtn.classList.remove('hidden');
        try{ localStorage.setItem(LS_KEY, '1'); }catch(e){}
      } else {
        sidebar.classList.remove('hidden');
        openBtn.classList.add('hidden');
        try{ localStorage.removeItem(LS_KEY); }catch(e){}
      }
    }

    // inicializa desde memoria
    const wasCollapsed = (function(){ try{ return localStorage.getItem(LS_KEY) === '1'; }catch(e){ return false; }})();
    setCollapsed(wasCollapsed);

    openBtn && openBtn.addEventListener('click', ()=> setCollapsed(false));
    closeBtn && closeBtn.addEventListener('click', ()=> setCollapsed(true));
  })();
</script>
<script>
  (function () {
    // === Persistencia de carpetas abiertas ===
    const LS_FOLDERS = 'sidebar:folders:open'; // guardamos un array de IDs

    function loadOpenSet() {
      try {
        const raw = localStorage.getItem(LS_FOLDERS);
        return new Set(raw ? JSON.parse(raw) : []);
      } catch (e) {
        return new Set();
      }
    }

    function saveOpenSet(set) {
      try {
        localStorage.setItem(LS_FOLDERS, JSON.stringify([...set]));
      } catch (e) {}
    }

    const openSet = loadOpenSet();
    const detailsList = document.querySelectorAll('details[data-folder-id]');

    // Aplica estado guardado al cargar:
    detailsList.forEach(d => {
      const id = String(d.dataset.folderId || '');
      if (id && openSet.has(id)) d.setAttribute('open', '');
      // Escucha cambios y persiste:
      d.addEventListener('toggle', () => {
        if (!id) return;
        if (d.open) openSet.add(id); else openSet.delete(id);
        saveOpenSet(openSet);
      });
    });
  })();
</script>
<script>
  (function(){
    const sidebar = document.getElementById('sidebar');
    const openBtn = document.getElementById('btn-open-sidebar');
    const closeBtn = document.getElementById('btn-close-sidebar');
    const LS_KEY = 'sidebar:collapsed';

    function setCollapsed(collapsed){
      if (!sidebar || !openBtn) return;
      if (collapsed){
        sidebar.classList.add('hidden');   // oculto
        openBtn.classList.remove('hidden'); // muestro botón de abrir
        try{ localStorage.setItem(LS_KEY, '1'); }catch(e){}
      } else {
        sidebar.classList.remove('hidden');
        openBtn.classList.add('hidden');
        try{ localStorage.removeItem(LS_KEY); }catch(e){}
      }
    }

    // Estado inicial desde localStorage:
    const wasCollapsed = (function(){ try{ return localStorage.getItem(LS_KEY) === '1'; }catch(e){ return false; }})();
    setCollapsed(wasCollapsed);

    // Listeners
    openBtn && openBtn.addEventListener('click', ()=> setCollapsed(false));
    closeBtn && closeBtn.addEventListener('click', ()=> setCollapsed(true));

    // (Opcional) atajo de teclado: presiona "S" para alternar
    document.addEventListener('keydown', (e) => {
      if (e.key.toLowerCase() === 's' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        const collapsed = localStorage.getItem(LS_KEY) === '1';
        setCollapsed(!collapsed);
      }
    });
  })();
</script>


</body>
</html>
